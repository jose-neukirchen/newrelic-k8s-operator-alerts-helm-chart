# Note: If using a k8s secret, remove `api_key`, uncomment `api_key_secret`,
# add your API key to examples/example_secret.yaml, and run
# `kubectl apply -f examples/example_secret.yaml`
{{- if .Values.alertCondition.createAlertCondition }}
{{- if .Values.alertCondition.createAlertCondition.enabled }}
{{- range .Values.alertCondition.conditions }}
---
apiVersion: nr.k8s.newrelic.com/v1
kind: AlertsNrqlCondition
metadata:
  name: {{ .name }}
spec:
  account_id: {{ $.Values.accountId }}
  api_key: {{ $.Values.apiKey }} 
  # api_key_secret:
  #   name: nr-api-key
  #   namespace: default
  #   key_name: api-key
  type: {{ .type }}
  {{- with .nrql }}
  nrql:
    query: {{ .query }}
    evaluationOffset: {{ .evaluationOffset }}
  {{- end }}
  enabled: {{ .enabled }}
  {{- with .terms }}
  terms:
    - threshold: {{ .threshold | quote }}
      threshold_occurrences: {{ .threshold_occurrences }}
      threshold_duration: {{ .threshold_duration }}
      priority: {{ .priority }}
      operator: {{ .operator }}
  {{- end }}
  {{- with .expiration }}
  expiration:
    expirationDuration: {{ .expirationDuration }}
    closeViolationsOnExpiration: {{ .closeViolationsOnExpiration }}
    openViolationOnExpiration: {{ .openViolationOnExpiration }}
  {{- end }}
#  signal:
#      aggregation_window: 360
#      evaluation_offset: 30
#      fill_option: NONE
#      fill_value: 15
  name: {{ .name }}
  violationTimeLimit: {{ .violationTimeLimit }}
  valueFunction: {{ .valueFunction }}
  # Must reference an existing New Relic alert policy from your account
  existing_policy_id: {{ .existingPolicyId | quote}}
  region: {{ .region }}
{{- end }}
{{- end }}
{{- end }}
